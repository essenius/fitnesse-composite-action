name: 'FitNesse Test Run'
description: 'Run a FitNesse test or suite'
inputs:
  test-spec:
    description: 'Test specification'
    required: true
    default: 'FibonacciTest?test'
  fixture-folder:
    description: the folder where the fixture assemblies and config,xml reside"
    required: true
    default: .
  include-html:
    description: 'Whether or not to include HTML in the test result'
    required: false
    default: true
  fitnesse-port:
    description: 'FitNesse port'
    required: false
    default: 8080
  fitnesse-release:
    description: 'FitNesse release number'
    required: false
    default: 20220319
  fitsharp-release:
    description: 'FitSharp release number'
    required: false
    default: 2022.3.29
  test-result:
    description: 'Folder of test results'
    required: false
    default: ${{github.workspace}}/testresult
runs:
  using: "composite"
  steps:
    - name: Check out the repo
      uses: actions/checkout@v3
      path: ./composite/
    - name: Download FitNesse
      shell: bash
      run: curl -o ${{github.workspace}}/fitnesse.jar "http://www.fitnesse.org/fitnesse-standalone.jar?responder=releaseDownload&release=${{inputs.fitnesse-release}}"
    - name: Configure dotnet
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: '5.0.x'
    - name: Download FitSharp
      shell: bash
      env:
        FITSHARP_FOLDER: ${{github.workspace}}/fitsharp
      run: |
        echo FitSharp: ${{env.FITSHARP_FOLDER}}
        mkdir -p ${{env.FITSHARP_FOLDER}}
        cd ${{runner.temp}}
        dotnet new classlib
        dotnet add package fitsharp --version ${{inputs.fitsharp-release}} --package-directory .
        cp -R fitsharp/${{inputs.fitsharp-release}}/lib ${{env.FITSHARP_FOLDER}}
        ls -lsR ${{github.workspace}}
        rm -rf ./*
    - name: Run test
      shell: bash
      run: |
        mkdir -p ${{inputs.test-result}}
        cd ${{inputs.fixture-folder}}
        includeHtml=""
        if [ "${{inputs.include-html}}" == true ]; then
          includeHtml="&includeHtmlSpec"
        fi
        java -jar ${{github.workspace}}/fitnesse.jar -p ${{inputs.fitnesse-port}} -d ${{github.workspace}} -e 0 -o -c "${{inputs.test-spec}}&format=xml&nochunk$includeHtml" 1>${{inputs.test-result}}/result.xml 2>${{env.TESTRESULT}}/error.log
        cd ${{github.workspace}}
    - name: Convert Test Output
      shell: pwsh
      working=directory: ./composite/
      if: always()
      run: run.ps1
    - name: Upload result
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-result
        path: ${{inputs.test-result}}
